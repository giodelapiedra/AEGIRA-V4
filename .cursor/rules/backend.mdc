---
description: AEGIRA Backend Rules - Hono + Prisma + PostgreSQL
globs: ["aegira-backend/**/*.ts"]
alwaysApply: false
---
# Backend Rules

Patterns defined in `.mdtools/context-factory/backend/`. Reference before writing code.

| Task | Context File |
|------|-------------|
| Create a module | `backend/module-structure.md` |
| Add routes | `backend/routes.md` |
| Write a controller | `backend/controllers.md` |
| Write a service | `backend/services.md` |
| Write a repository | `backend/repositories.md` |
| Write validators | `backend/validators.md` |
| Handle errors | `backend/error-handling.md` |
| Add middleware | `backend/middleware.md` |

## Quick Reference

- Module path: `src/modules/<feature>/` → routes, controller, repository, validator, service (optional)
- Middleware chain: `authMiddleware` → `tenantMiddleware` → `roleMiddleware` → `zValidator` → `controller`
- Pagination: `parsePagination()` + `calculateSkip()` + `paginate()` from `shared/utils`
- Tenant isolation: extend `BaseRepository`, use `this.where()` for reads, `this.withCompany()` for creates
- Errors: `Errors.notFound()`, `Errors.forbidden()`, or `new AppError('CODE', 'message', status)`
- Response: `{ success: true, data: { ... } }`
- Specific routes BEFORE dynamic `/:id` routes
- Validate ALL inputs: `zValidator('json', ...)` for body, `zValidator('query', ...)` for query params, `zValidator('param', ...)` for path params
- PK lookups: use `findUnique` (not `findFirst`) with `{ id, company_id }` in repositories
- Timezone: use `c.get('companyTimezone')` from tenant middleware — never query DB for it
